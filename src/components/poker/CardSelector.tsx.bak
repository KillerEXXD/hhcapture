/**
 * CardSelector Component
 *
 * Interactive component for selecting player cards (rank and suit)
 * Features:
 * - Rank buttons (A, 2-9, 10, J, Q, K)
 * - Suit buttons (♠, ♥, ♦, ♣)
 * - Keyboard shortcuts (a-9, t for 10, j, q, k | s, h, d, c for suits)
 * - Card availability validation
 * - Focus management with Tab navigation
 */

import React, { useState, useRef } from 'react';
import type { Card, Rank, Suit } from '../../types/poker';

interface CardSelectorProps {
  playerId: number;
  cardNumber: 1 | 2;
  currentCard: Card | null | undefined;
  onCardChange: (playerId: number, cardNumber: 1 | 2, card: Card) => void;
  isCardAvailable: (playerId: number, cardNumber: number, rank: string, suit: string) => boolean;
  areAllSuitsTaken: (playerId: number, cardNumber: number, rank: string) => boolean;
}

export const CardSelector: React.FC<CardSelectorProps> = ({
  playerId,
  cardNumber,
  currentCard,
  onCardChange,
  isCardAvailable,
  areAllSuitsTaken,
}) => {
  const [isFocused, setIsFocused] = useState(false);
  const [pendingRank, setPendingRank] = useState<string | null>(null);
  const containerRef = useRef<HTMLDivElement>(null);

  const ranksRow1 = ['A', '2', '3', '4', '5', '6', '7', '8', '9'];
  const ranksRow2 = ['K', 'Q', 'J', '10'];
  const suits = ['♠', '♥', '♦', '♣'];

  const suitColors: Record<string, string> = {
    '♠': 'text-gray-900',
    '♣': 'text-green-700',
    '♥': 'text-red-600',
    '♦': 'text-blue-600',
  };

  // Get the effective rank to display (either from currentCard or pendingRank)
  const displayRank = currentCard?.rank || pendingRank;
  const displaySuit = currentCard?.suit;

  const handleRankSelect = (rank: string) => {
    // Convert '10' to 'T' for the Rank type
    const normalizedRank = rank === '10' ? 'T' : rank;

    // If clicking the same rank that's already in currentCard, deselect it
    if (currentCard?.rank === normalizedRank) {
      onCardChange(playerId, cardNumber, null);
      setPendingRank(null);
      return;
    }

    // Check if current suit is still available with new rank
    const currentSuit = currentCard?.suit;
    if (currentSuit && isCardAvailable(playerId, cardNumber, normalizedRank, currentSuit)) {
      // Keep the suit with new rank
      onCardChange(playerId, cardNumber, {
        rank: normalizedRank as Rank,
        suit: currentSuit as Suit,
      });
      setPendingRank(null);
    } else {
      // Just set pending rank, wait for suit selection
      setPendingRank(normalizedRank);
      onCardChange(playerId, cardNumber, null);
    }
  };

  const handleSuitSelect = (suit: string) => {
    const effectiveRank = currentCard?.rank || pendingRank;
    if (!effectiveRank) {
      return; // Must select rank first
    }

    const isAvailable = isCardAvailable(playerId, cardNumber, effectiveRank, suit);
    const isCurrentSelection = currentCard?.suit === suit;

    if (!isAvailable && !isCurrentSelection) {
      return; // Suit not available
    }

    // Toggle suit selection: deselect if same, otherwise set new suit
    if (isCurrentSelection) {
      onCardChange(playerId, cardNumber, null);
      // Keep pending rank if there was one
      if (pendingRank) {
        setPendingRank(effectiveRank);
      }
    } else {
      onCardChange(playerId, cardNumber, {
        rank: effectiveRank as Rank,
        suit: suit as Suit,
      });
      setPendingRank(null);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    const key = e.key.toLowerCase();

    // Rank shortcuts: a, k, q, j, t (for 10), 2-9
    const rankMap: Record<string, string> = {
      a: 'A',
      k: 'K',
      q: 'Q',
      j: 'J',
      t: '10',
      '2': '2',
      '3': '3',
      '4': '4',
      '5': '5',
      '6': '6',
      '7': '7',
      '8': '8',
      '9': '9',
    };

    if (rankMap[key]) {
      e.preventDefault();
      e.stopPropagation();
      handleRankSelect(rankMap[key]);
      return;
    }

    // Suit shortcuts: d=diamond, c=clubs, h=hearts, s=spades
    const suitMap: Record<string, string> = {
      d: '♦',
      c: '♣',
      h: '♥',
      s: '♠',
    };

    if (suitMap[key]) {
      e.preventDefault();
      e.stopPropagation();
      handleSuitSelect(suitMap[key]);
      return;
    }

    // Tab navigation handled by browser default
  };

  return (
    <div
      ref={containerRef}
      className={`rounded p-1 transition-all outline-none ${
        isFocused
          ? 'border-2 border-blue-400 bg-blue-50 ring-2 ring-blue-500'
          : 'border-2 border-gray-300 bg-gray-50'
      }`}
      tabIndex={0}
      onKeyDown={handleKeyDown}
      onFocus={() => setIsFocused(true)}
      onBlur={(e) => {
        if (!containerRef.current?.contains(e.relatedTarget as Node)) {
          setIsFocused(false);
        }
      }}
      role="button"
      aria-label={`Card ${cardNumber}: ${displayRank || '?'}${displaySuit || '?'}`}
    >
      {/* Card Display - Prominent with colored suits */}
      <div className="text-sm font-bold mb-1">
        <span className="text-gray-700">Card {cardNumber}: </span>
        {displayRank || '?'}
        {displaySuit && (
          <span className={`${suitColors[displaySuit]} text-lg`}>{displaySuit}</span>
        )}
      </div>

      {/* Keyboard Shortcuts - More compact */}
      <div className="text-xs text-gray-500 mb-1 font-mono">
        a-9,t | d,c,h,s
      </div>

      {/* Rank Buttons Row 1 */}
      <div className="flex gap-0.5 mb-0.5">
        {ranksRow1.map((rank) => {
          const normalizedRank = rank === '10' ? 'T' : rank;
          const allSuitsTaken = areAllSuitsTaken(playerId, cardNumber, normalizedRank);
          const isCurrentSelection = displayRank === normalizedRank;
          const isDisabled = allSuitsTaken && !isCurrentSelection;

          return (
            <button
              key={rank}
              type="button"
              disabled={isDisabled}
              onMouseDown={(e) => {
                e.preventDefault();
                if (!isDisabled) {
                  handleRankSelect(rank);
                }
              }}
              className={`flex-1 px-0.5 py-0.5 text-xs font-bold rounded transition-colors ${
                isCurrentSelection
                  ? 'bg-blue-600 text-white ring-2 ring-blue-400'
                  : isDisabled
                  ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                  : 'bg-white text-gray-800 hover:bg-blue-100 border border-gray-300'
              }`}
            >
              {rank}
            </button>
          );
        })}
      </div>

      {/* Rank Buttons Row 2 */}
      <div className="flex gap-0.5 mb-0.5">
        {ranksRow2.map((rank) => {
          const normalizedRank = rank === '10' ? 'T' : rank;
          const allSuitsTaken = areAllSuitsTaken(playerId, cardNumber, normalizedRank);
          const isCurrentSelection = displayRank === normalizedRank;
          const isDisabled = allSuitsTaken && !isCurrentSelection;

          return (
            <button
              key={rank}
              type="button"
              disabled={isDisabled}
              onMouseDown={(e) => {
                e.preventDefault();
                if (!isDisabled) {
                  handleRankSelect(rank);
                }
              }}
              className={`flex-1 px-0.5 py-0.5 text-xs font-bold rounded transition-colors ${
                isCurrentSelection
                  ? 'bg-blue-600 text-white ring-2 ring-blue-400'
                  : isDisabled
                  ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                  : 'bg-white text-gray-800 hover:bg-blue-100 border border-gray-300'
              }`}
            >
              {rank === '10' ? 'T' : rank}
            </button>
          );
        })}
      </div>

      {/* Suit Buttons */}
      <div className="flex gap-0.5">
        {suits.map((suit) => {
          const isAvailable = displayRank
            ? isCardAvailable(playerId, cardNumber, displayRank, suit)
            : false;
          const isCurrentSelection = displaySuit === suit;
          const isDisabled = !displayRank || (!isAvailable && !isCurrentSelection);

          return (
            <button
              key={suit}
              type="button"
              disabled={isDisabled}
              onMouseDown={(e) => {
                e.preventDefault();
                if (!isDisabled) {
                  handleSuitSelect(suit);
                }
              }}
              className={`flex-1 px-0.5 py-0.5 text-base font-bold rounded transition-colors ${
                isCurrentSelection
                  ? 'bg-blue-600 text-white ring-2 ring-blue-400'
                  : isDisabled
                  ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                  : `bg-white ${suitColors[suit]} hover:bg-blue-100 border border-gray-300`
              }`}
            >
              {suit}
            </button>
          );
        })}
      </div>
    </div>
  );
};
